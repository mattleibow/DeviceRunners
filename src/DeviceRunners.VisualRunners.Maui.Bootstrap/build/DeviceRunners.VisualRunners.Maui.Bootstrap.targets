<?xml version="1.0" encoding="utf-8"?>
<Project>
  
  <!-- Add iOS partial app manifest -->
  <ItemGroup Condition="'$(TargetPlatformIdentifier)' == 'ios'">
    <PartialAppManifest Include="$(MSBuildThisFileDirectory)templates/iOS/Info.plist" />
  </ItemGroup>

  <!-- Add macOS Catalyst partial app manifest -->
  <ItemGroup Condition="'$(TargetPlatformIdentifier)' == 'maccatalyst'">
    <PartialAppManifest Include="$(MSBuildThisFileDirectory)templates/MacCatalyst/Info.plist" />
  </ItemGroup>

  <!-- Individual template processing targets for CallTarget -->
  <Target Name="ProcessAndroidMainActivity">
    <PropertyGroup>
      <TemplateFile>$(MSBuildThisFileDirectory)templates/Platforms/Android/MainActivity.cs.template</TemplateFile>
      <DestinationFile>$(IntermediateOutputPath)Platforms/Android/MainActivity.cs</DestinationFile>
    </PropertyGroup>
    
    <ReadLinesFromFile File="$(TemplateFile)">
      <Output TaskParameter="Lines" ItemName="_TemplateLines" />
    </ReadLinesFromFile>
    
    <PropertyGroup>
      <_ProcessedContent>@(_TemplateLines, '%0D%0A')</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{RootNamespace}}', '$(RootNamespace)'))</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{ApplicationTitle}}', '$(ApplicationTitle)'))</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{ApplicationId}}', '$(ApplicationId)'))</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{AppId}}', '$(ApplicationId)'))</_ProcessedContent>
    </PropertyGroup>
    
    <WriteLinesToFile File="$(DestinationFile)" Lines="$(_ProcessedContent)" Overwrite="true" />
  </Target>

  <Target Name="ProcessAndroidMainApplication">
    <PropertyGroup>
      <TemplateFile>$(MSBuildThisFileDirectory)templates/Platforms/Android/MainApplication.cs.template</TemplateFile>
      <DestinationFile>$(IntermediateOutputPath)Platforms/Android/MainApplication.cs</DestinationFile>
    </PropertyGroup>
    
    <ReadLinesFromFile File="$(TemplateFile)">
      <Output TaskParameter="Lines" ItemName="_TemplateLines" />
    </ReadLinesFromFile>
    
    <PropertyGroup>
      <_ProcessedContent>@(_TemplateLines, '%0D%0A')</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{RootNamespace}}', '$(RootNamespace)'))</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{ApplicationTitle}}', '$(ApplicationTitle)'))</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{ApplicationId}}', '$(ApplicationId)'))</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{AppId}}', '$(ApplicationId)'))</_ProcessedContent>
    </PropertyGroup>
    
    <WriteLinesToFile File="$(DestinationFile)" Lines="$(_ProcessedContent)" Overwrite="true" />
  </Target>

  <Target Name="ProcessiOSProgram">
    <PropertyGroup>
      <TemplateFile>$(MSBuildThisFileDirectory)templates/Platforms/iOS/Program.cs.template</TemplateFile>
      <DestinationFile>$(IntermediateOutputPath)Platforms/iOS/Program.cs</DestinationFile>
    </PropertyGroup>
    
    <ReadLinesFromFile File="$(TemplateFile)">
      <Output TaskParameter="Lines" ItemName="_TemplateLines" />
    </ReadLinesFromFile>
    
    <PropertyGroup>
      <_ProcessedContent>@(_TemplateLines, '%0D%0A')</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{RootNamespace}}', '$(RootNamespace)'))</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{ApplicationTitle}}', '$(ApplicationTitle)'))</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{ApplicationId}}', '$(ApplicationId)'))</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{AppId}}', '$(ApplicationId)'))</_ProcessedContent>
    </PropertyGroup>
    
    <WriteLinesToFile File="$(DestinationFile)" Lines="$(_ProcessedContent)" Overwrite="true" />
  </Target>

  <Target Name="ProcessiOSAppDelegate">
    <PropertyGroup>
      <TemplateFile>$(MSBuildThisFileDirectory)templates/Platforms/iOS/AppDelegate.cs.template</TemplateFile>
      <DestinationFile>$(IntermediateOutputPath)Platforms/iOS/AppDelegate.cs</DestinationFile>
    </PropertyGroup>
    
    <ReadLinesFromFile File="$(TemplateFile)">
      <Output TaskParameter="Lines" ItemName="_TemplateLines" />
    </ReadLinesFromFile>
    
    <PropertyGroup>
      <_ProcessedContent>@(_TemplateLines, '%0D%0A')</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{RootNamespace}}', '$(RootNamespace)'))</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{ApplicationTitle}}', '$(ApplicationTitle)'))</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{ApplicationId}}', '$(ApplicationId)'))</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{AppId}}', '$(ApplicationId)'))</_ProcessedContent>
    </PropertyGroup>
    
    <WriteLinesToFile File="$(DestinationFile)" Lines="$(_ProcessedContent)" Overwrite="true" />
  </Target>

  <Target Name="ProcessMacCatalystProgram">
    <PropertyGroup>
      <TemplateFile>$(MSBuildThisFileDirectory)templates/Platforms/MacCatalyst/Program.cs.template</TemplateFile>
      <DestinationFile>$(IntermediateOutputPath)Platforms/MacCatalyst/Program.cs</DestinationFile>
    </PropertyGroup>
    
    <ReadLinesFromFile File="$(TemplateFile)">
      <Output TaskParameter="Lines" ItemName="_TemplateLines" />
    </ReadLinesFromFile>
    
    <PropertyGroup>
      <_ProcessedContent>@(_TemplateLines, '%0D%0A')</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{RootNamespace}}', '$(RootNamespace)'))</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{ApplicationTitle}}', '$(ApplicationTitle)'))</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{ApplicationId}}', '$(ApplicationId)'))</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{AppId}}', '$(ApplicationId)'))</_ProcessedContent>
    </PropertyGroup>
    
    <WriteLinesToFile File="$(DestinationFile)" Lines="$(_ProcessedContent)" Overwrite="true" />
  </Target>

  <Target Name="ProcessMacCatalystAppDelegate">
    <PropertyGroup>
      <TemplateFile>$(MSBuildThisFileDirectory)templates/Platforms/MacCatalyst/AppDelegate.cs.template</TemplateFile>
      <DestinationFile>$(IntermediateOutputPath)Platforms/MacCatalyst/AppDelegate.cs</DestinationFile>
    </PropertyGroup>
    
    <ReadLinesFromFile File="$(TemplateFile)">
      <Output TaskParameter="Lines" ItemName="_TemplateLines" />
    </ReadLinesFromFile>
    
    <PropertyGroup>
      <_ProcessedContent>@(_TemplateLines, '%0D%0A')</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{RootNamespace}}', '$(RootNamespace)'))</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{ApplicationTitle}}', '$(ApplicationTitle)'))</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{ApplicationId}}', '$(ApplicationId)'))</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{AppId}}', '$(ApplicationId)'))</_ProcessedContent>
    </PropertyGroup>
    
    <WriteLinesToFile File="$(DestinationFile)" Lines="$(_ProcessedContent)" Overwrite="true" />
  </Target>

  <Target Name="ProcessWindowsAppXamlCs">
    <PropertyGroup>
      <TemplateFile>$(MSBuildThisFileDirectory)templates/Platforms/Windows/App.xaml.cs.template</TemplateFile>
      <DestinationFile>$(IntermediateOutputPath)Platforms/Windows/App.xaml.cs</DestinationFile>
    </PropertyGroup>
    
    <ReadLinesFromFile File="$(TemplateFile)">
      <Output TaskParameter="Lines" ItemName="_TemplateLines" />
    </ReadLinesFromFile>
    
    <PropertyGroup>
      <_ProcessedContent>@(_TemplateLines, '%0D%0A')</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{RootNamespace}}', '$(RootNamespace)'))</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{ApplicationTitle}}', '$(ApplicationTitle)'))</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{ApplicationId}}', '$(ApplicationId)'))</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{AppId}}', '$(ApplicationId)'))</_ProcessedContent>
    </PropertyGroup>
    
    <WriteLinesToFile File="$(DestinationFile)" Lines="$(_ProcessedContent)" Overwrite="true" />
  </Target>

  <Target Name="ProcessWindowsAppXaml">
    <PropertyGroup>
      <TemplateFile>$(MSBuildThisFileDirectory)templates/Windows/App.xaml</TemplateFile>
      <DestinationFile>$(IntermediateOutputPath)Platforms/Windows/App.xaml</DestinationFile>
    </PropertyGroup>
    
    <ReadLinesFromFile File="$(TemplateFile)">
      <Output TaskParameter="Lines" ItemName="_TemplateLines" />
    </ReadLinesFromFile>
    
    <PropertyGroup>
      <_ProcessedContent>@(_TemplateLines, '%0D%0A')</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{RootNamespace}}', '$(RootNamespace)'))</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{ApplicationTitle}}', '$(ApplicationTitle)'))</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{ApplicationId}}', '$(ApplicationId)'))</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{AppId}}', '$(ApplicationId)'))</_ProcessedContent>
    </PropertyGroup>
    
    <WriteLinesToFile File="$(DestinationFile)" Lines="$(_ProcessedContent)" Overwrite="true" />
  </Target>

  <Target Name="ProcessWindowsAppManifest">
    <PropertyGroup>
      <TemplateFile>$(MSBuildThisFileDirectory)templates/Windows/app.manifest</TemplateFile>
      <DestinationFile>$(IntermediateOutputPath)Platforms/Windows/app.manifest</DestinationFile>
    </PropertyGroup>
    
    <ReadLinesFromFile File="$(TemplateFile)">
      <Output TaskParameter="Lines" ItemName="_TemplateLines" />
    </ReadLinesFromFile>
    
    <PropertyGroup>
      <_ProcessedContent>@(_TemplateLines, '%0D%0A')</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{RootNamespace}}', '$(RootNamespace)'))</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{ApplicationTitle}}', '$(ApplicationTitle)'))</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{ApplicationId}}', '$(ApplicationId)'))</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{AppId}}', '$(ApplicationId)'))</_ProcessedContent>
    </PropertyGroup>
    
    <WriteLinesToFile File="$(DestinationFile)" Lines="$(_ProcessedContent)" Overwrite="true" />
  </Target>

  <Target Name="ProcessWindowsPackageAppxManifest">
    <PropertyGroup>
      <TemplateFile>$(MSBuildThisFileDirectory)templates/Windows/Package.appxmanifest</TemplateFile>
      <DestinationFile>$(IntermediateOutputPath)Platforms/Windows/Package.appxmanifest</DestinationFile>
    </PropertyGroup>
    
    <ReadLinesFromFile File="$(TemplateFile)">
      <Output TaskParameter="Lines" ItemName="_TemplateLines" />
    </ReadLinesFromFile>
    
    <PropertyGroup>
      <_ProcessedContent>@(_TemplateLines, '%0D%0A')</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{RootNamespace}}', '$(RootNamespace)'))</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{ApplicationTitle}}', '$(ApplicationTitle)'))</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{ApplicationId}}', '$(ApplicationId)'))</_ProcessedContent>
      <_ProcessedContent>$(_ProcessedContent.Replace('{{AppId}}', '$(ApplicationId)'))</_ProcessedContent>
    </PropertyGroup>
    
    <WriteLinesToFile File="$(DestinationFile)" Lines="$(_ProcessedContent)" Overwrite="true" />
  </Target>

  <!-- Android platform files -->
  <Target Name="PrepareAndroidFiles" BeforeTargets="BeforeCompile" Condition="'$(TargetPlatformIdentifier)' == 'android' AND '$(_ShouldGenerateDeviceTestApp)' == 'true'">
    <MakeDir Directories="$(IntermediateOutputPath)Platforms/Android/" />
    
    <!-- Process all Android template files -->
    <CallTarget Targets="ProcessAndroidMainActivity;ProcessAndroidMainApplication" />
  </Target>

  <!-- iOS platform files -->
  <Target Name="PrepareiOSFiles" BeforeTargets="BeforeCompile" Condition="'$(TargetPlatformIdentifier)' == 'ios' AND '$(_ShouldGenerateDeviceTestApp)' == 'true'">
    <MakeDir Directories="$(IntermediateOutputPath)Platforms/iOS/" />
    
    <!-- Process all iOS template files -->
    <CallTarget Targets="ProcessiOSProgram;ProcessiOSAppDelegate" />
  </Target>

  <!-- macOS Catalyst platform files -->
  <Target Name="PrepareMacCatalystFiles" BeforeTargets="BeforeCompile" Condition="'$(TargetPlatformIdentifier)' == 'maccatalyst' AND '$(_ShouldGenerateDeviceTestApp)' == 'true'">
    <MakeDir Directories="$(IntermediateOutputPath)Platforms/MacCatalyst/" />
    
    <!-- Process all macOS Catalyst template files -->
    <CallTarget Targets="ProcessMacCatalystProgram;ProcessMacCatalystAppDelegate" />
  </Target>

  <!-- Windows platform files -->
  <Target Name="PrepareWindowsFiles" BeforeTargets="BeforeCompile" Condition="'$(TargetPlatformIdentifier)' == 'windows' AND '$(_ShouldGenerateDeviceTestApp)' == 'true'">
    <MakeDir Directories="$(IntermediateOutputPath)Platforms/Windows/" />
    
    <!-- Process all Windows template files -->
    <CallTarget Targets="ProcessWindowsAppXamlCs;ProcessWindowsAppXaml;ProcessWindowsAppManifest;ProcessWindowsPackageAppxManifest" />
  </Target>

  <!-- Add the processed platform C# files to the build -->
  <ItemGroup Condition="'$(TargetPlatformIdentifier)' == 'android' AND '$(_ShouldGenerateDeviceTestApp)' == 'true'">
    <Compile Include="$(IntermediateOutputPath)Platforms/Android/MainActivity.cs" />
    <Compile Include="$(IntermediateOutputPath)Platforms/Android/MainApplication.cs" />
  </ItemGroup>

  <ItemGroup Condition="'$(TargetPlatformIdentifier)' == 'ios' AND '$(_ShouldGenerateDeviceTestApp)' == 'true'">
    <Compile Include="$(IntermediateOutputPath)Platforms/iOS/Program.cs" />
    <Compile Include="$(IntermediateOutputPath)Platforms/iOS/AppDelegate.cs" />
  </ItemGroup>

  <ItemGroup Condition="'$(TargetPlatformIdentifier)' == 'maccatalyst' AND '$(_ShouldGenerateDeviceTestApp)' == 'true'">
    <Compile Include="$(IntermediateOutputPath)Platforms/MacCatalyst/Program.cs" />
    <Compile Include="$(IntermediateOutputPath)Platforms/MacCatalyst/AppDelegate.cs" />
  </ItemGroup>

  <ItemGroup Condition="'$(TargetPlatformIdentifier)' == 'windows' AND '$(_ShouldGenerateDeviceTestApp)' == 'true'">
    <Compile Include="$(IntermediateOutputPath)Platforms/Windows/App.xaml.cs" />
    <Page Include="$(IntermediateOutputPath)Platforms/Windows/App.xaml" />
    <ApplicationManifest Include="$(IntermediateOutputPath)Platforms/Windows/app.manifest" />
    <AppxManifest Include="$(IntermediateOutputPath)Platforms/Windows/Package.appxmanifest" />
  </ItemGroup>

  <!-- Exclude default Visual Studio test runner files from packaging -->
  <Target Name="RemoveVisualStudioTestRunner" BeforeTargets="_ComputeAppxPackagePayload">
    <ItemGroup>
      <_VisualStudioTestRunnerFiles Include="@(PackagingOutputs)" Condition="$([System.String]::Copy('%(PackagingOutputs.FullPath)').Contains('xunit.runner.visualstudio'))" />
      <PackagingOutputs Remove="@(_VisualStudioTestRunnerFiles)" />
    </ItemGroup>
  </Target>

  <!-- Add default app icon and splash screen from templates -->
  <ItemGroup>
    <MauiIcon Include="$(MSBuildThisFileDirectory)templates/Resources/AppIcon/appicon.svg" ForegroundFile="$(MSBuildThisFileDirectory)templates/Resources/AppIcon/appiconfg.svg" Color="#512BD4" />
    <MauiSplashScreen Include="$(MSBuildThisFileDirectory)templates/Resources/Splash/splash.svg" Color="#512BD4" BaseSize="128,128" />
  </ItemGroup>

</Project>