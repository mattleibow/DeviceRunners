@using DeviceTestingKitApp.ViewModels
@using DeviceTestingKitApp.Converters
@implements IDisposable

<button id="CounterButton" 
        class="btn btn-primary" 
        @onclick="HandleIncrement"
        title="Counts the number of times you click">
    @GetCounterText()
</button>

@code {
    [Parameter] public CounterViewModel? ViewModel { get; set; }

    protected override void OnParametersSet()
    {
        if (ViewModel != null)
        {
            ViewModel.PropertyChanged += OnViewModelPropertyChanged;
        }
    }

    private void OnViewModelPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        if (e.PropertyName == nameof(CounterViewModel.Count))
        {
            InvokeAsync(StateHasChanged);
        }
    }

    private void HandleIncrement()
    {
        ViewModel?.IncrementCommand.Execute(null);
    }

    private string GetCounterText()
    {
        if (ViewModel == null) return CounterTextConverter.ConvertCountToText(0);
        
        return CounterTextConverter.ConvertCountToText(ViewModel.Count);
    }

    public void Dispose()
    {
        if (ViewModel != null)
        {
            ViewModel.PropertyChanged -= OnViewModelPropertyChanged;
        }
    }
}